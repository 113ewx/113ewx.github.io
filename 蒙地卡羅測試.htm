<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€€ä¼‘å…¨ç”Ÿå‘½é€±æœŸæ¨¡æ“¬å™¨ (Ver 5.0 Growth)</title>
    <style>
        :root {
            --bg: #121212;
            --card: #1e1e1e;
            --text: #e0e0e0;
            --accent: #4caf50;
            --danger: #ff6b6b;
            --warn: #f1c40f;
            --info: #2196f3;
            --growth: #9c27b0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            background-color: var(--card);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 900px;
        }

        h2 {
            margin-top: 0;
            border-bottom: 1px solid #444;
            padding-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .tag {
            font-size: 0.5em;
            background: #333;
            padding: 4px 8px;
            border-radius: 4px;
            vertical-align: middle;
            color: var(--growth);
            border: 1px solid var(--growth);
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 0.85em;
            margin-bottom: 5px;
            color: #aaa;
        }

        input {
            background: #2c2c2c;
            border: 1px solid #444;
            color: white;
            padding: 10px;
            border-radius: 6px;
            font-size: 1em;
            width: 100%;
            box-sizing: border-box;
        }

        input:focus {
            border-color: var(--accent);
            outline: none;
        }

        button {
            grid-column: span 3;
            background: linear-gradient(135deg, #9c27b0, #673ab7);
            color: white;
            border: none;
            padding: 15px;
            font-size: 1.1em;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(156, 39, 176, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(156, 39, 176, 0.4);
        }

        .section-header {
            grid-column: span 3;
            color: var(--accent);
            font-weight: bold;
            margin-top: 10px;
            border-bottom: 1px dashed #444;
            padding-bottom: 5px;
        }

        .advisor-box {
            background: #252525;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .advisor-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #fff;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .card-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .status-card {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #555;
        }

        .status-card.good {
            border-left-color: var(--accent);
        }

        .status-card.bad {
            border-left-color: var(--danger);
        }

        .card-label {
            font-size: 0.9em;
            color: #aaa;
            margin-bottom: 5px;
        }

        .card-value {
            font-size: 1.4em;
            font-weight: bold;
            color: #fff;
        }

        .card-desc {
            font-size: 0.85em;
            color: #888;
            margin-top: 5px;
            line-height: 1.4;
        }

        .solution-box {
            grid-column: span 2;
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .solution-title {
            color: var(--info);
            font-weight: bold;
            margin-bottom: 8px;
        }

        .solution-item {
            margin-bottom: 8px;
            font-size: 0.95em;
            color: #ddd;
        }

        .warning-box {
            background: rgba(255, 152, 0, 0.1);
            border: 1px solid #ff9800;
            color: #ff9800;
            padding: 10px;
            border-radius: 4px;
            margin-top: 15px;
            font-size: 0.9em;
            display: none;
            /* Default hidden */
        }

        .warning-box ul {
            margin: 5px 0 0 20px;
            padding: 0;
        }

        .warning-box li {
            margin-bottom: 3px;
        }

        canvas {
            background: #222;
            width: 100%;
            height: 350px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #333;
            margin-top: 20px;
            border: 1px solid #333;
            cursor: crosshair;
        }

        #flowChart {
            height: 200px;
            /* Shorter than main chart */
        }

        .chart-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.85);
            color: #fff;
            padding: 10px;
            border-radius: 6px;
            pointer-events: none;
            font-size: 0.85em;
            border: 1px solid #555;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 100;
        }

        .tooltip-row {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-bottom: 3px;
        }

        .dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }



        /* Help Section Styles */
        .help-section {
            margin-top: 30px;
            border-top: 1px solid #444;
            padding-top: 20px;
        }

        details {
            background: #252525;
            border-radius: 8px;
            padding: 10px;
            border: 1px solid #333;
            margin-bottom: 20px;
        }

        summary {
            cursor: pointer;
            font-weight: bold;
            color: var(--info);
            padding: 5px;
            list-style: none;
            /* Hide default triangle */
        }

        summary::-webkit-details-marker {
            display: none;
        }

        summary::after {
            content: " â–¼";
            font-size: 0.8em;
        }

        details[open] summary::after {
            content: " â–²";
        }

        .help-content {
            padding: 15px;
            color: #ccc;
            line-height: 1.6;
            font-size: 0.95em;
        }

        .help-block {
            margin-bottom: 20px;
        }

        .help-title {
            color: var(--accent);
            font-weight: bold;
            margin-bottom: 8px;
            display: block;
            border-bottom: 1px dashed #444;
            padding-bottom: 3px;
        }

        .term {
            color: var(--warn);
            font-weight: bold;
        }

        /* Tab Navigation Styles */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }

        .tab-btn {
            background: transparent;
            border: none;
            color: #888;
            font-size: 1.1em;
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            color: #ccc;
        }

        .tab-btn.active {
            color: var(--accent);
            border-bottom: 3px solid var(--accent);
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Adjustments for Guide View */
        #view-guide .help-section {
            margin-top: 0;
            border-top: none;
            padding-top: 0;
        }

        #view-guide .help-content {
            padding: 0;
        }

        /* --- Premium Card System (Card UI) --- */

        .solution-box {
            background: #252422;
            /* Default Dark (Warm) */
            border-left: 4px solid #888;
            border-radius: 8px;
            padding: 20px 25px;
            margin-top: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            text-align: left;
            position: relative;
            line-height: 1.6;
        }

        /* Gold Card (FIRE) */
        .solution-box.gold {
            background: #22201c;
            border-left-color: #FFD700;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
        }

        /* Green Card (Investment Feasible) */
        .solution-box.green {
            background: #1b2224;
            border-left-color: #2ecc71;
        }

        /* Red Card (Risk Alert) */
        .solution-box.red {
            background: #251b1b;
            border-left-color: #ff6b6b;
        }

        .sol-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .sol-icon {
            font-size: 1.8em;
            margin-right: 15px;
        }

        .sol-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #fff;
        }

        .sol-body {
            font-size: 1.1em;
            color: #ccc;
            margin-bottom: 15px;
        }

        .sol-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            margin: 0 2px;
        }

        .sol-tag.green {
            color: #2ecc71;
            background: rgba(46, 204, 113, 0.15);
        }

        .sol-tag.gold {
            color: #FFD700;
            background: rgba(255, 215, 0, 0.15);
        }

        .sol-stats {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 6px;
            font-size: 0.95em;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .stat-item {
            display: flex;
            flex-direction: column;
        }

        .stat-label {
            font-size: 0.85em;
            color: #888;
            margin-bottom: 2px;
        }

        .stat-val {
            font-size: 1.2em;
            font-weight: bold;
            color: #eee;
        }

        .sol-note {
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
            text-align: right;
            font-style: italic;
        }

        .apply-btn {
            background: #2b3a42;
            color: var(--accent);
            border: 1px solid var(--accent);
            padding: 4px 12px;
            font-size: 0.9em;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .apply-btn:hover {
            background: var(--accent);
            color: #1a1a1a;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2>å…¨ç”Ÿå‘½é€±æœŸæ¨¡æ“¬å™¨ <span class="tag">Ver 5.0 (Growth)</span></h2>

        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('sim')">ğŸ“Ÿ æ¨¡æ“¬å™¨</button>
            <button class="tab-btn" onclick="switchTab('guide')">ğŸ“˜ ä½¿ç”¨èªªæ˜</button>
        </div>

        <!-- View 1: Simulator -->
        <div id="view-sim" class="tab-content active">
            <div class="grid">
                <div class="section-header">1. è¨­å®šç›®æ¨™ (Target)</div>
                <div class="input-group"><label>é€€ä¼‘å¾Œã€Œæ¯æœˆã€é–‹éŠ· (æŠ˜ç®—ç¾å€¼)</label><input type="number" id="monthlySpend"
                        value="44000"></div>
                <div class="input-group"><label>å†å·¥ä½œå¹¾å¹´é€€ä¼‘? (å­˜éŒ¢æœŸ)</label><input type="number" id="workYears" value="35">
                </div>
                <div class="input-group"><label>é€€ä¼‘å¾Œè¦æ´»å¹¾å¹´? (æé ˜æœŸ)</label><input type="number" id="retireYears" value="28">
                </div>
                <div class="section-header">2. æŠ•å…¥è³‡æº (Input)</div>
                <div class="input-group"><label>ç›®å‰å·²æœ‰æœ¬é‡‘</label><input type="number" id="initialCapital" value="200000">
                </div>
                <div class="input-group"><label>ç¾åœ¨ã€Œæ¯æœˆã€æŠ•å…¥ (èµ·é»)</label><input type="number" id="monthlyContrib"
                        value="5000">
                </div>
                <div class="input-group"><label style="color: var(--growth);">æŠ•å…¥é‡‘é¡å¹´å¢é•·ç‡ (%)</label><input type="number"
                        id="contribGrowth" value="5" title="éš¨è–ªè³‡æˆé•·ï¼Œæ¯å¹´å¢åŠ æŠ•å…¥çš„å¹…åº¦"></div>


                <!-- Expert Params Toggle -->
                <div style="grid-column: span 3; display: flex; align-items: center; margin-top: 10px; margin-bottom: 5px; cursor: pointer;"
                    onclick="toggleExpert()" title="é»æ“Šé¡¯ç¤º/éš±è—é€²éšè¨­å®š">
                    <div style="flex-grow: 1; height: 1px; background: #444;"></div>
                    <div style="padding: 0 10px; color: #888; font-size: 0.9em;">âš™ï¸ é€²éšåƒæ•¸è¨­å®š <span
                            style="font-size:0.8em; color:#666;">(é»æ“Šå±•é–‹)</span> <span id="expertArrow">â–¼</span></div>
                    <div style="flex-grow: 1; height: 1px; background: #444;"></div>
                </div>

                <div id="expertParams"
                    style="display:none; grid-column: span 3; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="section-header" style="margin-top:0;">3. ç’°å¢ƒåƒæ•¸ (Context)</div>
                    <div
                        style="grid-column: span 3; margin-bottom: 10px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px;">
                        <label style="color:var(--accent); font-weight:bold; margin-right:10px;">âš¡ å¿«é€Ÿæ¨¡æ¿
                            (Templates):</label>
                        <select id="templateSelect"
                            style="padding: 5px; border-radius: 4px; background: #333; color: #fff; border: 1px solid #555;">
                            <option value="custom">è‡ªè¨‚åƒæ•¸ (Custom)</option>
                        </select>
                        <div id="templateDesc" style="margin-top:5px; font-size:0.85em; color:#aaa; font-style:italic;">
                        </div>
                    </div>

                    <div class="input-group"><label>é æœŸå¹´åŒ–å ±é…¬ç‡ (%)</label><input type="number" id="meanReturn" value="10"
                            oninput="resetTemplate()">
                    </div>
                    <div class="input-group"><label>æ³¢å‹•ç‡/æ¨™æº–å·® (%)</label><input type="number" id="volatility" value="15"
                            oninput="resetTemplate()">
                    </div>
                    <div class="input-group"><label>é æœŸé€šè†¨ç‡ (%)</label><input type="number" id="inflation" value="2.0">
                    </div>
                    <div class="input-group"><label style="color:var(--accent)">ç›®æ¨™æˆåŠŸç‡ (%)</label><input type="number"
                            id="targetSuccessRate" value="90"></div>
                </div>

                <button onclick="runAnalysis()" style="margin-top: 15px;">ğŸš€ é–‹å§‹æ¨¡æ“¬
                    (å«æŠ•å…¥æˆé•·é‹ç®—)</button>

                <div id="warningBox" class="warning-box"></div>
            </div>

            <div id="advisorArea" class="advisor-box">
                <div class="advisor-title">ğŸ“Š æ™ºèƒ½è¨ºæ–·å ±å‘Š</div>
                <div class="card-grid">
                    <div class="status-card" id="cardSuccess">
                        <div class="card-label">æœ€çµ‚æˆåŠŸç‡</div>
                        <div class="card-value" id="valSuccessRate">--%</div>
                        <div class="card-desc" id="descSuccess">æ­£åœ¨è¨ˆç®—...</div>
                    </div>
                    <div class="status-card">
                        <div class="card-label">å®‰å…¨åŸºæº–è³‡ç”¢ (é€€ä¼‘æ™‚)</div>
                        <div class="card-value" id="valRetireAsset">--</div>
                        <div class="card-desc" id="descRetireAsset">å«æŠ•å…¥æˆé•·çš„ä¿å®ˆä¼°å€¼ (å¯¦è³ª)</div>
                        <div
                            style="margin-top:8px; border-top:1px solid #444; padding-top:5px; font-size:0.85em; color:#888;">
                            ä¸­ä½æ•¸ (PR50): <span id="valMedianAsset" style="color:#ddd">--</span></div>
                    </div>
                    <div class="status-card">
                        <div class="card-label">ç´¯ç©æŠ•å…¥æœ¬é‡‘ (é€€ä¼‘æ™‚)</div>
                        <div class="card-value" id="valTotalPrincipal">--</div>
                        <div class="card-desc" id="descTotalPrincipal">å¯¦è³ªåƒ¹å€¼ (æ‰£é™¤é€šè†¨)</div>
                    </div>
                    <div class="solution-box" id="solutionArea" style="display:none">
                        <div id="solutionContent"></div>
                    </div>
                    <div class="solution-box" id="congratsArea"
                        style="display:none; background: rgba(76, 175, 80, 0.1); border-color: rgba(76, 175, 80, 0.3);">
                        <div class="solution-title" style="color: var(--accent)">ğŸ‰ æ­å–œï¼æ‚¨å·²è²¡å¯Œè‡ªç”±</div>
                        <div style="font-size:0.95em; color:#ddd;">ä¾æ“šæœ€ä¿å®ˆçš„ä¼°ç®—
                            (å¿½ç•¥æŠ•è³‡æ”¶ç›Š)ï¼Œæ‚¨ç›®å‰çš„æœ¬é‡‘å·²å¤§æ–¼æœªä¾†æ‰€æœ‰å¹´ä»½çš„å¯¦è³ªé–‹éŠ·ç¸½å’Œã€‚æ‚¨å¯ä»¥éš¨æ™‚é¸æ“‡é€€ä¼‘ï¼Œäº«å—äººç”Ÿï¼</div>
                    </div>
                </div>
            </div>
            <div style="position: relative;">
                <canvas id="chart"></canvas>
                <div id="tooltip" class="chart-tooltip"></div>
            </div>

            <!-- Cash Flow Chart -->
            <div style="margin-top: 20px; border-top: 1px dashed #444; padding-top: 10px;">
                <div class="section-header" style="border:none; margin-bottom:5px;">ğŸ’° å¹´åº¦æ”¶æ”¯æµå‘ (å¯¦è³ªè³¼è²·åŠ›)</div>
                <div style="font-size:0.85em; color:#888; margin-bottom:10px;">é•·æ¢åœ–é¡¯ç¤ºæ¯å¹´çš„ã€Œå¯¦è³ªæŠ•å…¥ã€(è—è‰²)
                    èˆ‡ã€Œå¯¦è³ªèŠ±è²»ã€(æ©˜è‰²)ã€‚è‹¥è—æ¢é€å¹´è®ŠçŸ­ï¼Œä»£è¡¨æŠ•å…¥å¢é•·è·Ÿä¸ä¸Šé€šè†¨ã€‚</div>
                <div style="position: relative;">
                    <canvas id="flowChart"></canvas>
                    <div id="flowTooltip" class="chart-tooltip"></div>
                </div>
            </div>

        </div><!-- End of view-sim -->

        <!-- View 2: Guide -->
        <div id="view-guide" class="tab-content">
            <div class="help-section">
                <div class="help-content">

                    <div class="help-block"><span class="help-title">ğŸ“– è¼¸å…¥æ¬„ä½è©³è§£ (Input Dictionary)</span>
                        <p style="color:#aaa; font-style:italic;">ç‚ºäº†å¾—åˆ°æœ€ç²¾æº–çš„æ¨¡æ“¬çµæœï¼Œè«‹åƒè€ƒä»¥ä¸‹å®šç¾©å¡«å¯«æ•¸å€¼ï¼š</p>
                        <dl style="margin-top:10px;">
                            <dt>ğŸ’° ç›®å‰å·²æœ‰æœ¬é‡‘ (Initial Capital)</dt>
                            <dd>ç›®å‰æ‰‹é‚Šå·²ç¶“æº–å‚™å¥½ï¼Œå°ˆé–€ç”¨æ–¼é€€ä¼‘æŠ•è³‡çš„æ·¨è³‡ç”¢ (ç¾é‡‘ + è‚¡ç¥¨ +å‚µåˆ¸)ã€‚ä¸åŒ…å«è‡ªä½æˆ¿ç”¢ã€‚</dd>

                            <dt>ğŸ“¥ ç¾åœ¨ã€Œæ¯æœˆã€æŠ•å…¥ (Monthly Contribution)</dt>
                            <dd>å¾ç¾åœ¨é–‹å§‹ï¼Œæ¯å€‹æœˆèƒ½å¾è–ªæ°´ä¸­å­˜ä¸‹ä¾†ä¸¦æŠ•å…¥æŠ•è³‡å¸³æˆ¶çš„é‡‘é¡ã€‚</dd>

                            <dt>ğŸ“ˆ æŠ•å…¥é‡‘é¡å¹´å¢é•·ç‡ (Contribution Growth)</dt>
                            <dd>éš¨è‘—å¹´è³‡å¢é•·ï¼Œè–ªæ°´é€šå¸¸æœƒå¢åŠ ã€‚æ­¤åƒæ•¸è¨­å®šæ‚¨çš„å­˜éŒ¢èƒ½åŠ›æ¯å¹´æˆé•·çš„å¹…åº¦ (å»ºè­°ä¿å®ˆè¨­ 3%~5%)ã€‚</dd>

                            <dt>â³ å†å·¥ä½œå¹¾å¹´é€€ä¼‘? (Accumulation Years)</dt>
                            <dd>é€™æ®µæœŸé–“ç¨±ç‚ºã€Œè³‡ç”¢ç´¯ç©æœŸã€ï¼Œç³»çµ±æœƒæ¨¡æ“¬æ‚¨æŒçºŒæŠ•å…¥è³‡é‡‘ä¸¦äº«å—è¤‡åˆ©æˆé•·ã€‚</dd>

                            <dt>ğŸ–ï¸ é€€ä¼‘å¾Œè¦æ´»å¹¾å¹´? (Retirement Years)</dt>
                            <dd>é€€ä¼‘å¾Œé æœŸæœƒæ´»å¤šä¹…ã€‚é€™æ®µæœŸé–“ç¨±ç‚ºã€Œè³‡ç”¢æé ˜æœŸã€ï¼Œæ‚¨å°‡åœæ­¢å·¥ä½œæ”¶å…¥ï¼Œé–‹å§‹æ¶ˆè€—è³‡ç”¢ (å»ºè­°è¨­é•·ä¸€é»ï¼Œå¦‚ 30~40 å¹´ä»¥é˜²é•·å£½é¢¨éšª)ã€‚</dd>

                            <dt>ğŸ’¸ é€€ä¼‘å¾Œã€Œæ¯æœˆã€é–‹éŠ· (Monthly Spending)</dt>
                            <dd>æ‚¨å¸Œæœ›é€€ä¼‘å¾Œæ¯å€‹æœˆèƒ½æœ‰å¤šå°‘ç”Ÿæ´»è²» (ä»¥<strong>ç¾åœ¨çš„ç‰©åƒ¹</strong>å¡«å¯«å³å¯)ã€‚<br>
                                <em>ä¾‹å¦‚ï¼šç¾åœ¨è¦ºå¾—æ¯å€‹æœˆ 5 è¬å¤ ç”¨å°±å¡« 5 è¬ï¼Œç³»çµ±æœƒè‡ªå‹•å¹«æ‚¨åŠ ä¸Š 30 å¹´å¾Œçš„é€šè†¨ã€‚</em>
                            </dd>
                        </dl>
                    </div>

                    <div class="help-block"><span class="help-title">âš™ï¸ é€²éšåƒæ•¸ (Expert Parameters)</span>
                        <div
                            style="background:rgba(255,255,255,0.05); padding:8px; border-radius:4px; margin-bottom:10px; font-size:0.9em;">
                            ğŸ’¡ ä½æ–¼ä¸»ç•«é¢çš„æŠ˜ç–Šé¸å–®ä¸­ï¼Œé»æ“Š<strong>ã€Œâš™ï¸ é€²éšåƒæ•¸è¨­å®šã€</strong>å³å¯å±•é–‹ã€‚
                        </div>
                        <dl>
                            <dt>ğŸ“Š é æœŸå¹´åŒ–å ±é…¬ç‡ (Mean Return)</dt>
                            <dd>æ‚¨æŠ•è³‡çµ„åˆçš„é•·æœŸå¹³å‡åç›®å ±é…¬ç‡ã€‚
                                <ul>
                                    <li>ä¿å®ˆ (å‚µåˆ¸ç‚ºä¸»)ï¼š4% ~ 6%</li>
                                    <li>ç©©å¥ (è‚¡å‚µå¹³è¡¡)ï¼š6% ~ 8%</li>
                                    <li>ç©æ¥µ (å…¨è‚¡ç¥¨)ï¼š8% ~ 10%</li>
                                </ul>
                            </dd>

                            <dt>ğŸŒŠ æ³¢å‹•ç‡ / æ¨™æº–å·® (Volatility)</dt>
                            <dd>è³‡ç”¢åƒ¹æ ¼ä¸Šä¸‹éœ‡ç›ªçš„å¹…åº¦ï¼Œæ˜¯è©•ä¼°é¢¨éšªçš„é—œéµã€‚æ³¢å‹•è¶Šå¤§ï¼Œé•·æœŸè¤‡åˆ©æŠ˜æè¶Šåš´é‡ã€‚
                                <ul>
                                    <li>ä½æ³¢å‹•ï¼š5% ~ 10%</li>
                                    <li>ä¸­æ³¢å‹•ï¼š10% ~ 15% (å¦‚ VT)</li>
                                    <li>é«˜æ³¢å‹•ï¼š15% ~ 20% (å¦‚ 0050, SPY)</li>
                                </ul>
                            </dd>

                            <dt>ğŸˆ é æœŸé€šè†¨ç‡ (Inflation)</dt>
                            <dd>éŒ¢è®Šè–„çš„é€Ÿåº¦ã€‚å°ç£é•·æœŸå¹³å‡ç´„ 1.5% ~ 2.0%ï¼Œä¿å®ˆè¦åŠƒå»ºè­°è¨­ 2.0% ~ 2.5%ã€‚</dd>

                            <dt>ğŸ¯ ç›®æ¨™æˆåŠŸç‡ (Target Success Rate)</dt>
                            <dd>æ‚¨å¸Œæœ›é€™ä»½é€€ä¼‘è¨ˆç•«æœ‰å¤šã€Œç©©ã€ï¼Ÿ
                                <ul>
                                    <li>PR50 (50%)ï¼šè·Ÿä¸ŸéŠ…æ¿ä¸€æ¨£ï¼Œæœ‰ä¸€åŠæ©Ÿç‡æœƒå¤±æ•—ã€‚</li>
                                    <li>PR90 (90%)ï¼šå³ä½¿é‹æ°£æ’åœ¨å€’æ•¸ 10%ï¼Œä¾ç„¶èƒ½å®‰ç©©é€€ä¼‘ (å»ºè­°å€¼)ã€‚</li>
                                </ul>
                            </dd>
                        </dl>
                    </div>

                    <div class="help-block"><span class="help-title">é—œéµè§€å¿µï¼šåç›® vs å¯¦è³ª</span>
                        æœ¬æ¨¡æ“¬å™¨çš„ä¸€å¤§ç‰¹è‰²æ˜¯å…¨é‚è¼¯æ¡ç”¨<strong>ã€Œå¯¦è³ªåƒ¹å€¼ (Real Value)ã€</strong>é‹ç®—ã€‚
                        è¼¸å…¥åƒæ•¸æ™‚è«‹å¡«å¯«å¸‚å ´æ…£ç”¨çš„ã€Œåç›®ã€æ•¸å€¼ (ä¾‹å¦‚å ±é…¬ç‡ 10%)ï¼Œç³»çµ±é‹ç®—æ™‚æœƒè‡ªå‹•å¹«æ‚¨æ‰£é™¤é€šè†¨ã€‚
                        <br><br>
                        <strong>ç‚ºä»€éº¼é€™å¾ˆé‡è¦ï¼Ÿ</strong><br>
                        å› ç‚º 30 å¹´å¾Œçš„ 1000 è¬ï¼Œè³¼è²·åŠ›å¯èƒ½åªå‰©ç¾åœ¨çš„ 500 è¬ã€‚çœ‹ã€Œå¯¦è³ªåƒ¹å€¼ã€æ‰èƒ½çœŸå¯¦åæ˜ æ‚¨é€€ä¼‘å¾Œçš„ç”Ÿæ´»æ°´æº–ã€‚
                    </div>

                </div>
            </div>
        </div>
    </div><!-- End of view-guide -->

    </div><!-- End of container -->

    <script>
        // Tab Switching Logic
        window.switchTab = function (tabId) { // Global function
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + tabId).classList.add('active');

            // Update buttons
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => {
                if (btn.getAttribute('onclick').includes(tabId)) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        /**
         * åˆ‡æ›ã€Œé€²éšåƒæ•¸ã€é¢æ¿çš„é¡¯ç¤ºç‹€æ…‹
         * Toggle visibility of the Expert Parameters panel.
         */
        function toggleExpert() {
            const panel = document.getElementById('expertParams');
            const arrow = document.getElementById('expertArrow');
            if (panel.style.display === 'none') {
                panel.style.display = 'grid'; // Grid layout
                arrow.innerText = 'â–²';
            } else {
                panel.style.display = 'none';
                arrow.innerText = 'â–¼';
            }
        }

        /**
         * Box-Muller è½‰æ›ç®—æ³•
         * ç”¢ç”Ÿç¬¦åˆæ¨™æº–å¸¸æ…‹åˆ†ä½ˆ (Mean=0, Std=1) çš„éš¨æ©Ÿæ•¸
         * @returns {number} Standard Normal Random Variable
         */
        function randn_bm() {
            let u = 0,
                v = 0;
            while (u === 0) u = Math.random(); // Converting [0,1) to (0,1)
            while (v === 0) v = Math.random();
            return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
        }

        /**
         * è²¨å¹£æ ¼å¼åŒ– (æ–°å°å¹£)
         * @param {number} num - æ•¸å€¼
         * @returns {string} e.g. "NT$1,000,000"
         */
        function formatMoney(num) {
            return num.toLocaleString('zh-TW', {
                style: 'currency', currency: 'TWD', maximumFractionDigits: 0
            });
        }

        /**
         * è¨ˆç®—å¹´é‡‘ç¾å€¼ (PV -> PMT)
         * çµ¦å®šæœ¬é‡‘ pvï¼Œåœ¨å¹´åŒ–å ±é…¬ç‡ r ä¸‹ï¼Œç¶­æŒ years å¹´ï¼Œæ¯å¹´å¯é ˜å¤šå°‘éŒ¢ï¼Ÿ
         * Formula: PMT = PV * r / (1 - (1+r)^-n)
         * @param {number} pv - Present Value (æœ¬é‡‘)
         * @param {number} r_annual - Annual Interest Rate (å¹´åˆ©ç‡)
         * @param {number} years - Number of Years (æœŸæ•¸)
         */
        function calculateSafeWithdrawal(pv, r_annual, years) {
            let r = r_annual;
            if (r <= 0) return pv / years;
            return (pv * r) / (1 - Math.pow(1 + r, -years));
        }

        /**
         * è¨ˆç®—æˆé•·å‹å¹´é‡‘çµ‚å€¼ (FV -> PMT)
         * åæ¨ï¼šç‚ºäº†é”æˆæœªä¾†è³‡ç”¢ FVï¼Œç¾åœ¨æ¯å¹´éœ€æŠ•å…¥å¤šå°‘ PMT (ä¸”æŠ•å…¥éš¨è–ªè³‡æˆé•· g)ï¼Ÿ
         * Formula: PMT = FV * (r-g) / ((1+r)^n - (1+g)^n)
         * @param {number} fv - Future Value (ç›®æ¨™è³‡ç”¢)
         * @param {number} r - Investment Rate (æŠ•è³‡å ±é…¬ç‡)
         * @param {number} g - Growth Rate (æŠ•å…¥å¢é•·ç‡)
         * @param {number} n - Years (æœŸæ•¸)
         */
        function calculateGrowingAnnuityPMT(fv, r, g, n) {
            if (Math.abs(r - g) < 0.0001) {
                // ç•¶ r â‰ˆ g æ™‚ (L'Hopital's approximation)
                // FV = PMT * n * (1+r)^(n-1)
                return fv / (n * Math.pow(1 + r, n - 1));
            }
            return fv * (r - g) / (Math.pow(1 + r, n) - Math.pow(1 + g, n));
        }

        // æ‡‰ç”¨æ–¹æ¡ˆå‡½å¼ (å…¨åŸŸå®šç¾©)
        window.applySchemeA = function (extraAmount) {
            let current = parseFloat(document.getElementById('monthlyContrib').value);
            document.getElementById('monthlyContrib').value = Math.round(current + extraAmount);
            runAnalysis();
        }

        window.applySchemeB = function (extraYears) {
            let currentWork = parseInt(document.getElementById('workYears').value);
            let currentRetire = parseInt(document.getElementById('retireYears').value);
            document.getElementById('workYears').value = currentWork + extraYears;
            // å‡è¨­å£½å‘½å›ºå®šï¼Œå»¶å¾Œé€€ä¼‘ N å¹´ = é€€ä¼‘æœŸç¸®çŸ­ N å¹´ã€‚ä½†è‡³å°‘ä¿ç•™ 1 å¹´é€€ä¼‘æœŸã€‚
            document.getElementById('retireYears').value = Math.max(1, currentRetire - extraYears);
            runAnalysis();
        }

        window.applySchemeC = function (newSpend) {
            document.getElementById('monthlySpend').value = Math.round(newSpend);
            runAnalysis();
        }

        // æ ¸å¿ƒæ¨¡æ“¬å‡½å¼ (ç´”è¨ˆç®—é‚è¼¯ï¼Œç¨ç«‹æ–¼ UI)
        /**
         * æ ¸å¿ƒè’™åœ°å¡ç¾…æ¨¡æ“¬å‡½å¼ (Core Monte Carlo Simulation)
         * ç´”è¨ˆç®—é‚è¼¯ï¼Œå®Œå…¨ç¨ç«‹æ–¼ UIï¼Œæ–¹ä¾¿è¢«ã€Œä¸»åœ–è¡¨ã€èˆ‡ã€Œæ±‚è§£å™¨ã€å…±ç”¨ã€‚
         * 
         * @param {number} initial - åˆå§‹æœ¬é‡‘ (Present Value)
         * @param {number} annualContrib - é¦–å¹´å¹´æŠ•å…¥é‡‘é¡ (Nominal)
         * @param {number} contribGrowth - æŠ•å…¥é‡‘é¡å¹´å¢é•·ç‡
         * @param {number} annualSpend - é€€ä¼‘å¾Œå¹´èŠ±è²» (Real Value, because input is present value) -> Logic treats it as Real
         * @param {number} infl - é æœŸé€šè†¨ç‡
         * @param {number} mean - é æœŸå¹´åŒ–å ±é…¬ç‡ (Nominal) -> converted to Real internally? No, logic uses Nominal return & infl.
         * @param {number} vol - æ³¢å‹•ç‡ (Standard Deviation)
         * @param {number} workYears - å·¥ä½œ/å­˜éŒ¢å¹´æœŸ
         * @param {number} totalYears - ç¸½æ¨¡æ“¬å¹´æœŸ (Work + Retire)
         * @param {number} simulations - æ¨¡æ“¬æ¬¡æ•¸ (e.g. 10000)
         * @param {boolean} needHistory - æ˜¯å¦éœ€è¦å›å‚³å®Œæ•´è·¯å¾‘ (ç¹ªåœ–ç”¨)ã€‚è‹¥ç‚º false å‰‡åƒ…å›å‚³æˆåŠŸç‡ (æ±‚è§£å™¨ç”¨ï¼Œç¯€çœè¨˜æ†¶é«”)ã€‚
         * @returns {object} { successCount, history, successRate }
         */
        function coreSimulate(initial, annualContrib, contribGrowth, annualSpend, infl, mean, vol, workYears, totalYears, simulations, needHistory) {
            let history = null;
            // è‹¥éœ€è¦ç¹ªè£½åœ–è¡¨æˆ–åˆ†æåˆ†ä½æ•¸ï¼Œå‰‡å•Ÿç”¨æ­·å²ç´€éŒ„é™£åˆ—
            if (needHistory) {
                history = Array.from({ length: totalYears + 1 }, () => []);
            }

            let successCount = 0;

            // --- å¹³è¡Œå®‡å®™å¾ªç’° (Simulation Loop) ---
            for (let i = 0; i < simulations; i++) {
                let value = initial;
                let currentAnnualContrib = annualContrib;

                // t=0 åˆå§‹ç‹€æ…‹
                if (needHistory) history[0].push(value);

                let isSuccess = true;

                // --- æ™‚é–“è»¸å¾ªç’° (Year Loop) ---
                for (let t = 1; t <= totalYears; t++) {
                    // éš¨æ©Ÿå ±é…¬ç‡ (Box-Muller)
                    let randomReturn = mean + vol * randn_bm();

                    if (t <= workYears) {
                        // [Phase 1: Accumulation / å­˜éŒ¢æœŸ]
                        // è³‡ç”¢æˆé•· + æ–°æŠ•å…¥è³‡é‡‘
                        value = value * (1 + randomReturn) + currentAnnualContrib;
                        // æŠ•å…¥é‡‘é¡éš¨è–ªè³‡æˆé•·
                        currentAnnualContrib = currentAnnualContrib * (1 + contribGrowth);
                    } else {
                        // [Phase 2: Decumulation / é€€ä¼‘æœŸ]
                        // è¨ˆç®—ç•¶å¹´åº¦åç›®èŠ±è²» (Nominal Spend = Real Spend * Inflation^t)
                        let nominalSpend = annualSpend * Math.pow(1 + infl, t);
                        // è³‡ç”¢æˆé•· - æé ˜èŠ±è²»
                        value = value * (1 + randomReturn) - nominalSpend;
                    }

                    // ç ´ç”¢åˆ¤å®š (Bankruptcy Check)
                    if (value < 0) {
                        value = 0;
                        isSuccess = false;
                    }

                    // è¨˜éŒ„å¯¦è³ªåƒ¹å€¼ (Convert Nominal to Real for History)
                    if (needHistory) {
                        let realValue = value / Math.pow(1 + infl, t);
                        history[t].push(realValue);
                    }
                }

                // çµ‚å±€åˆ¤å®šï¼šè³‡ç”¢ > 0 å³ç‚ºæˆåŠŸ (å­˜æ´»)
                if (value > 0) successCount++;
            }

            return {
                successCount: successCount,
                history: history,
                successRate: (successCount / simulations) * 100
            };
        }

        // ==========================================
        //         3. è³‡ç”¢é…ç½®æ¨¡æ¿ (Templates)
        // ==========================================

        // DOM å…ƒç´ å¼•ç”¨
        const tmplSelect = document.getElementById('templateSelect');
        const tmplDesc = document.getElementById('templateDesc');

        /**
         * è³‡ç”¢é…ç½®æ¨¡æ¿æ•¸æ“š (Nominal Return Estimates)
         * æ¡ç”¨é•·æœŸæ­·å²åç›®å ±é…¬ç‡é ä¼°å€¼ (User-Provided)
         * - mean: åç›®å¹´åŒ–å ±é…¬ç‡ (%)
         * - vol: æ¨™æº–å·®/æ³¢å‹•ç‡ (%)
         */
        const ASSET_TEMPLATES = {
            '0050': { label: '100% å°ç£ 0050 (TW Large Cap)', mean: 10.0, vol: 15.0, desc: 'å°è‚¡ä»£è¡¨ (åç›®å¹´åŒ– ~10.0%, æ³¢å‹• 15.0%)' },
            'VTI': { label: '100% ç¾åœ‹ VTI (US Total Stock)', mean: 10.5, vol: 14.0, desc: 'ç¾è‚¡å…¨å¸‚å ´ (åç›®å¹´åŒ– ~10.5%, æ³¢å‹• 14.0%)' },
            'VT': { label: '100% å…¨çƒ VT (Global Stock)', mean: 8.4, vol: 15.0, desc: 'å…¨çƒåˆ†æ•£ (åç›®å¹´åŒ– ~8.4%, æ³¢å‹• 15.0%)' },
            '6040': { label: '60% è‚¡ / 40% å‚µ (60/40 Portfolio)', mean: 6.5, vol: 10.0, desc: 'ç¶“å…¸è‚¡å‚µé…ç½® (åç›®å¹´åŒ– ~6.5%, æ³¢å‹• 10.0%)' }
        };

        // åˆå§‹åŒ–æ¨¡æ¿ä¸‹æ‹‰é¸å–® (é¿å…é‡è¤‡åŸ·è¡Œ)
        if (tmplSelect.options.length === 1) {
            // 1. ç”¢ç”Ÿé¸é …
            for (let key in ASSET_TEMPLATES) {
                let opt = document.createElement('option');
                opt.value = key;
                opt.innerText = ASSET_TEMPLATES[key].label;
                tmplSelect.appendChild(opt);
            }

            // 2. ç›£è½é¸æ“‡äº‹ä»¶
            tmplSelect.addEventListener('change', function () {
                const key = this.value;
                if (key === 'custom') {
                    tmplDesc.innerText = "";
                    return;
                }
                const data = ASSET_TEMPLATES[key];

                // è‡ªå‹•å¡«å…¥åƒæ•¸
                document.getElementById('meanReturn').value = data.mean;
                document.getElementById('volatility').value = data.vol;
                tmplDesc.innerText = data.desc;

                // ç«‹å³è§¸ç™¼é‹ç®—
                runAnalysis();
            });
        }

        /**
         * é‡ç½®æ¨¡æ¿ç‹€æ…‹ç‚ºã€Œè‡ªè¨‚ã€
         * ç•¶ä½¿ç”¨è€…æ‰‹å‹•ä¿®æ”¹åƒæ•¸è¼¸å…¥æ¡†æ™‚è§¸ç™¼
         */
        function resetTemplate() {
            document.getElementById('templateSelect').value = 'custom';
            document.getElementById('templateDesc').innerText = "";
        }

        /**
         * ä¸»åˆ†æå‡½å¼ (Main Analysis Procedure)
         * è² è²¬ UI è³‡æ–™ç¶å®šã€å•Ÿå‹•æ¨¡æ“¬ã€ä¸¦æ›´æ–°çµæœç•«é¢
         */
        function runAnalysis() {
            // ==========================================
            //            1. è®€å–èˆ‡è™•ç†åƒæ•¸
            // ==========================================
            const monthlySpend = parseFloat(document.getElementById('monthlySpend').value);
            const annualSpend = monthlySpend * 12;

            const workYears = parseInt(document.getElementById('workYears').value);
            const retireYears = parseInt(document.getElementById('retireYears').value);
            const totalYears = workYears + retireYears;

            const initial = parseFloat(document.getElementById('initialCapital').value);
            const monthlyContrib = parseFloat(document.getElementById('monthlyContrib').value);
            const annualContrib = monthlyContrib * 12;

            // åƒæ•¸ï¼šæŠ•å…¥å¢é•·ç‡
            const contribGrowth = parseFloat(document.getElementById('contribGrowth').value) / 100 || 0;

            const mean = parseFloat(document.getElementById('meanReturn').value) / 100 || 0.05;
            const vol = parseFloat(document.getElementById('volatility').value) / 100 || 0.15;
            const infl = parseFloat(document.getElementById('inflation').value) / 100 || 0.02;
            let targetRate = parseFloat(document.getElementById('targetSuccessRate').value) || 90;

            // [Bug Fix] é™åˆ¶ç›®æ¨™æˆåŠŸç‡ä¸è¶…é 99.9%
            if (targetRate >= 100) {
                targetRate = 99.9;
                document.getElementById('targetSuccessRate').value = 99.9;
                // æ³¨æ„: è­¦å‘Šè¨Šæ¯å°‡åœ¨ä¸‹æ–¹é˜²å‘†æª¢æŸ¥å€å¡Šä¸€åŒåŠ å…¥
            }

            // ==========================================
            //         2. é˜²å‘†æª¢æŸ¥ (Sanity Check)
            // ==========================================
            let warnings = [];

            // è² å€¼æª¢æŸ¥ (Negative Value Check)
            if (workYears < 0) warnings.push("å­˜éŒ¢æœŸä¸èƒ½ç‚ºè² ï¼Œæ™‚å…‰æ©Ÿå°šæœªç™¼æ˜ã€‚");
            if (retireYears < 0) warnings.push("é€€ä¼‘æœŸä¸èƒ½ç‚ºè² ï¼Œè«‹çæƒœç”Ÿå‘½ã€‚");
            if (monthlyContrib < 0) warnings.push("æ¯æœˆæŠ•å…¥é‡‘é¡ä¸èƒ½ç‚ºè² æ•¸ (æœ¬ç³»çµ±é è¨­å·¥ä½œæœŸé–“ç‚ºç´¯ç©è³‡ç”¢)ã€‚");
            if (monthlySpend < 0) warnings.push("æ¯æœˆèŠ±è²»ä¸èƒ½ç‚ºè² ï¼Œé™¤éæ‚¨æ˜¯é å…‰åˆä½œç”¨ç”Ÿå­˜ã€‚");
            if (initial < 0) warnings.push("åˆå§‹æœ¬é‡‘ä¸èƒ½ç‚ºè²  (æœ¬æ¨¡æ“¬å™¨åƒ…è¨ˆç®—è³‡ç”¢å¢é•·ï¼Œä¸é©ç”¨æ–¼è² å‚µå„Ÿé‚„æ¨¡å‹)ã€‚");

            // å¹´é™æª¢æŸ¥
            if (workYears + totalYears - workYears > 100) warnings.push("è¦åŠƒç¸½å¹´æœŸè¶…é 100 å¹´ï¼Ÿé€™ä¼¼ä¹æ˜¯é‡å°é•·ç”Ÿä¸è€è—¥çš„è¦åŠƒã€‚");
            if (workYears > 60) warnings.push("å·¥ä½œå¹´æœŸè¶…é 60 å¹´ï¼Œæ‚¨æ‰“ç®—å·¥ä½œåˆ° 80 æ­²ä»¥ä¸Šå—ï¼Ÿ");
            if (totalYears - workYears > 50) warnings.push("é€€ä¼‘æœŸè¶…é 50 å¹´ï¼Œé€™éœ€è¦éå¸¸é¾å¤§çš„è³‡æœ¬ã€‚");

            // åˆ©ç‡æª¢æŸ¥
            if (mean * 100 > 15) warnings.push("é æœŸå¹´åŒ–å ±é…¬ç‡ > 15%ï¼Œç”šè‡³é«˜æ–¼å·´è²ç‰¹çš„é•·æœŸæ°´æº–ï¼Œå¯èƒ½éåº¦æ¨‚è§€ã€‚");
            if (vol * 100 > 30) warnings.push("æ³¢å‹•ç‡ > 30%ï¼Œé€™æ˜¯åŠ å¯†è²¨å¹£ç­‰ç´šçš„æ³¢å‹•ï¼Œå¿ƒè‡Ÿè¦å¾ˆå¤§é¡†ã€‚");
            if (vol * 100 < 2) warnings.push("æ³¢å‹•ç‡ < 2%ï¼Œé€™æ¯”å®šå­˜é‚„ç©©ï¼Œå¯èƒ½è¨­å®šæœ‰èª¤ã€‚");
            if (infl * 100 > 10) warnings.push("é æœŸé€šè†¨ > 10%ï¼Œé€™é€šå¸¸ç™¼ç”Ÿåœ¨æƒ¡æ€§é€šè†¨æ™‚æœŸã€‚");

            // å…¶ä»–
            if (targetRate < 50) warnings.push("ç›®æ¨™æˆåŠŸç‡ < 50%ï¼Œé€™è·Ÿä¸ŸéŠ…æ¿æ±ºå®šé€€ä¼‘å‘½é‹å·®ä¸å¤šã€‚");
            if (targetRate >= 99.9) warnings.push("ç›®æ¨™æˆåŠŸç‡æœ€é«˜åªèƒ½ç‚º 99.9% (çµ±è¨ˆä¸Šç„¡æ³•ä¿è­‰ 100% çµ•å°æˆåŠŸ)ã€‚");

            const warnBox = document.getElementById('warningBox');
            if (warnings.length > 0) {
                warnBox.style.display = 'block';
                // é˜²æ­¢åŸ·è¡Œï¼šè‹¥æœ‰é‚è¼¯åš´é‡éŒ¯èª¤ (å¦‚è² æ™‚é–“)ï¼Œæ‡‰åœæ­¢æ¨¡æ“¬
                if (workYears < 0 || retireYears < 0 || monthlyContrib < 0 || monthlySpend < 0 || initial < 0) {
                    warnBox.innerHTML = `<strong>âš ï¸ æ•¸å€¼éŒ¯èª¤ (æ¨¡æ“¬åœæ­¢)ï¼š</strong><ul>${warnings.map(w => `<li>${w}</li>`).join('')}</ul>`;
                    return; // Stop execution
                } else {
                    warnBox.innerHTML = `<strong>âš ï¸ æº«é¦¨æç¤ºï¼š</strong><ul>${warnings.map(w => `<li>${w}</li>`).join('')}</ul>`;
                }
            } else {
                warnBox.style.display = 'none';
            }

            // ==========================================
            //            3. åŸ·è¡Œä¸»æ¨¡æ“¬
            // ==========================================

            // æ¨¡æ“¬æ¬¡æ•¸ (ä¸»åœ–è¡¨ä½¿ç”¨é«˜è§£æåº¦)
            const SIMULATIONS = 15000;

            // å‘¼å«æ ¸å¿ƒé‚è¼¯ (é–‹å•Ÿæ­·å²ç´€éŒ„ needHistory: true)
            let simResult = coreSimulate(
                initial, annualContrib, contribGrowth,
                annualSpend, infl,
                mean, vol,
                workYears, totalYears, SIMULATIONS,
                true
            );

            let history = simResult.history;
            let successCount = simResult.successCount;


            // ==========================================
            //         4. æ•¸æ“šåˆ†æ (Statistics)
            // ==========================================

            // --- è¨ˆç®—è·¯å¾‘è³‡ç”¢ (Principal Path) ---
            // é‚è¼¯ï¼šPrincipal æ˜¯åç›®æŠ•å…¥ç´¯ç©ï¼Œä½†åœ¨åœ–è¡¨ä¸Šé¡¯ç¤ºå¯¦è³ªåƒ¹å€¼
            // ç”¨æ–¼ç¹ªè£½åœ–è¡¨ä¸Šçš„ç°è‰²è™›ç·š (é¡¯ç¤ºã€Œå¦‚æœä¸æŠ•è³‡ï¼ŒéŒ¢æœƒè®Šå¤šå°‘ã€)
            let principalHistory = [];
            let nominalPrincipalHistory = [];
            let currentNominalPrincipal = initial;
            let currentAnnualContribForPrincipal = annualContrib;

            // t=0
            principalHistory.push(initial);
            nominalPrincipalHistory.push(initial);

            for (let t = 1; t <= totalYears; t++) {
                if (t <= workYears) {
                    currentNominalPrincipal += currentAnnualContribForPrincipal;
                    currentAnnualContribForPrincipal = currentAnnualContribForPrincipal * (1 + contribGrowth);
                }
                // é€€ä¼‘å¾Œåç›®æœ¬é‡‘ä¸è®Š (ä¸å†æŠ•å…¥)
                nominalPrincipalHistory.push(currentNominalPrincipal);

                // è½‰å¯¦è³ª (Real Value Calculation)
                let realPrincipal = currentNominalPrincipal / Math.pow(1 + infl, t);
                principalHistory.push(realPrincipal);
            }

            // --- è¨ˆç®—ç¾é‡‘æµæ­·å² (Bar Chart Data) ---
            let flowHistory = [];
            let currNomContrib = annualContrib; // Year 1 Nominal

            for (let t = 1; t <= totalYears; t++) {
                let nominalSpendAtT = annualSpend * Math.pow(1 + infl, t);

                if (t <= workYears) {
                    // å­˜éŒ¢æœŸï¼šè¨˜éŒ„æŠ•å…¥
                    let realFlow = currNomContrib / Math.pow(1 + infl, t);
                    flowHistory.push({ year: t, val: realFlow, nominal: currNomContrib, type: 'IN' });
                    currNomContrib *= (1 + contribGrowth);
                }
                else {
                    // é€€ä¼‘æœŸï¼šè¨˜éŒ„èŠ±è²» (å¯¦è³ªèŠ±è²»ç‚ºå®šå€¼)
                    flowHistory.push({ year: t, val: -annualSpend, nominal: -nominalSpendAtT, type: 'OUT' });
                }
            }

            // --- çµ±è¨ˆé—œéµåˆ†ä½æ•¸ ---
            const finalSuccessRate = (successCount / SIMULATIONS) * 100;

            // å°‡æ‰€æœ‰æ¨¡æ“¬çµæœçš„ã€Œé€€ä¼‘ç•¶ä¸‹è³‡ç”¢ã€æ’åºï¼Œæ‰¾å‡º PR å€¼
            history[workYears].sort((a, b) => a - b);

            // å–å¾—å°æ‡‰ç›®æ¨™æˆåŠŸç‡çš„ã€Œé–€æª»è³‡ç”¢ã€(ä¾‹å¦‚ PR10 ä»£è¡¨æœ€å·®çš„ 10%)
            const riskPercentile = Math.max(0.01, (100 - targetRate) / 100);
            const riskIndex = Math.floor(SIMULATIONS * riskPercentile);
            const criticalRetireAsset = history[workYears][riskIndex];

            // å–å¾—ä¸­ä½æ•¸è³‡ç”¢ (PR50) ä¾›åƒè€ƒ
            const medianIndex = Math.floor(SIMULATIONS * 0.5);
            const medianRetireAsset = history[workYears][medianIndex];


            // ==========================================
            //      5. æ™ºèƒ½è¨ºæ–·æ±‚è§£ (Diagnostic Solver)
            // ==========================================

            // å®šç¾©ï¼šä¸å†ä¾è³´éœæ…‹å…¬å¼ï¼Œè€Œæ˜¯é€éæ•¸å€¼æ–¹æ³• (Iterative Method) è©¦èª¤æ±‚è§£ã€‚
            // ç¢ºä¿å»ºè­°æ–¹æ¡ˆèƒ½é©æ‡‰å„ç¨®éç·šæ€§æ¢ä»¶ã€‚

            const SOLVER_SIMS = 2000; // é™ä½æ¨¡æ“¬æ¬¡æ•¸ä»¥åŠ å¿«é‹ç®— (ç²¾åº¦è¶³å¤ )

            /**
             * é€šç”¨æ±‚è§£å™¨ï¼šå°‹æ‰¾è®“æˆåŠŸç‡é”æ¨™çš„ç‰¹å®šåƒæ•¸å€¼
             * @param {string} type - 'extraMonthly', 'extraYears', 'safeSpend'
             * @returns {number} bestVal - å»ºè­°çš„èª¿æ•´å€¼
             */
            function solveDiagnostic(type) {
                let lower = 0;
                let upper = 0;
                let bestVal = 0;

                // è¨­å®šæœå°‹ç¯„åœ
                if (type === 'extraMonthly') {
                    lower = 0;
                    upper = monthlySpend * 10;
                } else if (type === 'extraYears') {
                    lower = 0;
                    upper = 40;
                } else if (type === 'safeSpend') {
                    lower = 0;
                    upper = monthlySpend;
                }

                // æ•¸å€¼åˆ†æè¿´åœˆ (12æ¬¡è¿­ä»£)
                for (let iter = 0; iter < 12; iter++) {
                    let mid = (lower + upper) / 2;
                    let simRate = 0;

                    // ä¾æ“šä¸åŒé¡å‹ï¼Œèª¿æ•´åƒæ•¸ä¸¦åŸ·è¡Œ Micro-Simulation
                    if (type === 'extraMonthly') {
                        let testAnnualContrib = annualContrib + (mid * 12);
                        // æ³¨æ„ï¼šé€™è£¡æ˜¯èª¿æ•´åˆå§‹æŠ•å…¥ï¼Œå¾ŒçºŒä»ä¿æœ‰æˆé•·ç‡
                        let res = coreSimulate(
                            initial, testAnnualContrib, contribGrowth,
                            annualSpend, infl, mean, vol, workYears, totalYears, SOLVER_SIMS, false
                        );
                        simRate = res.successRate;
                    }
                    else if (type === 'extraYears') {
                        let testWorkYears = workYears + Math.round(mid);
                        let testRetireYears = retireYears - Math.round(mid);
                        if (testRetireYears < 1) testRetireYears = 1;

                        let res = coreSimulate(
                            initial, annualContrib, contribGrowth,
                            annualSpend, infl, mean, vol,
                            testWorkYears, testWorkYears + testRetireYears, SOLVER_SIMS, false
                        );
                        simRate = res.successRate;
                    }
                    else if (type === 'safeSpend') {
                        let testAnnualSpend = mid * 12;
                        let res = coreSimulate(
                            initial, annualContrib, contribGrowth,
                            testAnnualSpend, infl, mean, vol, workYears, totalYears, SOLVER_SIMS, false
                        );
                        simRate = res.successRate;
                    }

                    // æª¢æŸ¥çµæœä¸¦ç¸®å°ç¯„åœ (Binary Search Logic)
                    if (type === 'safeSpend') {
                        // æ”¯å‡ºè¶Šå°‘ï¼ŒæˆåŠŸç‡è¶Šé«˜ (åå‘é—œä¿‚)
                        if (simRate < targetRate) {
                            upper = mid; // å¤±æ•— -> èŠ±å¤ªå…‡ -> æ¸›å°‘ä¸Šé™
                        } else {
                            lower = mid;
                            bestVal = mid;
                        }
                    } else {
                        // æŠ•å…¥/å¹´é™è¶Šå¤šï¼ŒæˆåŠŸç‡è¶Šé«˜ (æ­£å‘é—œä¿‚)
                        if (simRate < targetRate) {
                            lower = mid; // å¤±æ•— -> ä¸å¤ åŠªåŠ› -> æé«˜ä¸‹é™
                        } else {
                            upper = mid;
                            bestVal = mid;
                        }
                    }
                }
                return bestVal;
            }

            // ----------------------------------------------------

            let extraInitialMonthly = 0;
            let extraYears = 0;
            let safeMonthlySpend = 0;
            let showCongrats = false;

            // --- FIRE Check (è²¡å¯Œè‡ªç”±æª¢æŸ¥) - ç›´è§€æ¼”ç®—æ³• (User Request) ---
            // ç”¨æˆ¶é‚è¼¯ï¼šå¦‚æœ æœ¬é‡‘ > ç¸½é–‹éŠ·ï¼Œä»£è¡¨å°±ç®—ä¸åšé«˜é¢¨éšªæŠ•è³‡ï¼Œåªæ±‚æŠ—é€šè†¨(å¯¦è³ªå ±é…¬0%)ï¼Œä¹Ÿèƒ½æ´»å®Œã€‚
            // é€™æ˜¯æœ€ç°¡å–®ç›´è§€çš„åˆ¤æ–·ï¼šæˆ‘æœ‰ 5000è¬ï¼Œå‰©ä¸‹ 50å¹´æ¯å¹´èŠ± 60è¬ (ç¸½éœ€3000è¬)ï¼Œé‚£ç•¶ç„¶å¤ ã€‚
            // å¿½ç•¥äº†åºåˆ—é¢¨éšªï¼Ÿæ˜¯çš„ï¼Œä½†ç•¶è¦†è“‹ç‡ > 100% æ™‚ï¼Œå…¶å¯¦å®¹éŒ¯ç©ºé–“å¾ˆå¤§ã€‚

            let totalNeededSimple = annualSpend * totalYears;

            if (initial >= totalNeededSimple) {
                showCongrats = true;
            }

            // 4. æ›´æ–° UI - çµ±ä¸€é‚è¼¯ (Unified Logic)
            const advisor = document.getElementById('advisorArea');
            advisor.style.display = 'block';

            const cardSuccess = document.getElementById('cardSuccess');
            const descSuccess = document.getElementById('descSuccess');

            document.getElementById('valSuccessRate').innerText = finalSuccessRate.toFixed(1) + "%";
            document.getElementById('valRetireAsset').innerText = formatMoney(criticalRetireAsset);
            document.getElementById('descRetireAsset').innerText = `åŸºæ–¼ PR${(riskPercentile * 100).toFixed(0)} (æœ€å·®${(riskPercentile * 100).toFixed(0)}%) çš„ä¿å®ˆä¼°å€¼`;
            document.getElementById('valMedianAsset').innerText = formatMoney(medianRetireAsset);
            document.getElementById('valTotalPrincipal').innerText = formatMoney(principalHistory[workYears]);

            if (showCongrats) {
                // æƒ…å¢ƒ 1: è²¡å¯Œè‡ªç”± (é‡‘è‰² Gold Card)
                cardSuccess.className = "status-card good";
                descSuccess.innerText = "è²¡å¯Œè‡ªç”±";

                const conArea = document.getElementById('congratsArea');
                conArea.className = "solution-box gold";
                conArea.style.display = 'block';
                // Clear inline styles to let CSS take over
                conArea.style.background = "";
                conArea.style.borderColor = "";

                conArea.innerHTML = `
                    <div class="sol-header">
                        <div class="sol-icon">ğŸ‘‘</div>
                        <div class="sol-title" style="color:#FFD700;">æ­å–œï¼æ‚¨å·²è²¡å¯Œè‡ªç”±</div>
                    </div>
                    <div class="sol-body">
                        ä¾æ“šæœ€ä¿å®ˆçš„ä¼°ç®— <span class="sol-tag gold">å¿½ç•¥æŠ•è³‡æ”¶ç›Š</span>ï¼Œæ‚¨çš„æœ¬é‡‘å·²è¶³ä»¥è¦†è“‹æœªä¾†æ‰€æœ‰é–‹éŠ·ã€‚
                    </div>
                    <div class="sol-stats">
                        <div class="stat-item">
                            <span class="stat-label">ç›®å‰æœ¬é‡‘ (Principal)</span>
                            <span class="stat-val" style="color:#FFD700;">${formatMoney(initial)}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">æœªä¾†ç¸½éœ€æ±‚ (Total Needed)</span>
                            <span class="stat-val">${formatMoney(totalNeededSimple)}</span>
                        </div>
                    </div>
                    <div class="sol-note">âœ¨ æ‚¨å¯ä»¥éš¨æ™‚é¸æ“‡é€€ä¼‘ï¼Œäº«å—äººç”Ÿï¼</div>
                `;
                document.getElementById('solutionArea').style.display = 'none';

            } else if (finalSuccessRate >= targetRate) {
                // æƒ…å¢ƒ 2: æŠ•è³‡é”æ¨™ (ç¶ è‰² Green Card)
                cardSuccess.className = "status-card good";
                descSuccess.innerText = "è³‡é‡‘å……è¶³";

                document.getElementById('congratsArea').style.display = 'none';
                document.getElementById('solutionArea').style.display = 'block';
                document.getElementById('solutionArea').className = "solution-box green"; // Apply Green Class

                let html = `
                    <div class="sol-header">
                        <div class="sol-icon">âœ…</div>
                        <div class="sol-title" style="color:#2ecc71;">æŠ•è³‡è¨ˆç•«å¯è¡Œ</div>
                    </div>
                    <div class="sol-body">
                        é è‘— <span class="sol-tag green">æŒçºŒæŠ•å…¥</span> èˆ‡ <span class="sol-tag green">è¤‡åˆ©æ•ˆæ‡‰</span>ï¼Œæ‚¨çš„è³‡ç”¢å¢é•·é æœŸå¯è¦†è“‹é€€ä¼‘é–‹éŠ·ã€‚
                    </div>
                    <div class="sol-stats">
                        <div class="stat-item">
                            <span class="stat-label">ç›®å‰æœ¬é‡‘</span>
                            <span class="stat-val">${formatMoney(initial)}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">æœªä¾†ç¸½éœ€æ±‚</span>
                            <span class="stat-val">${formatMoney(totalNeededSimple)}</span>
                        </div>
                    </div>
                    <div class="sol-note">(éœ€ä»°è³´æŠ•è³‡å›å ±å¡«è£œæœ¬é‡‘ç¼ºå£)</div>
                `;
                document.getElementById('solutionContent').innerHTML = html;

            } else {
                // æƒ…å¢ƒ 3: æœªé”æ¨™ (ç´…è‰² Red Card)
                cardSuccess.className = "status-card bad";
                descSuccess.innerText = "æœªé” " + targetRate + "% ç›®æ¨™";

                document.getElementById('congratsArea').style.display = 'none';
                document.getElementById('solutionArea').style.display = 'block';
                document.getElementById('solutionArea').className = "solution-box red"; // Apply Red Class

                // åŸ·è¡Œè¨ºæ–·æ±‚è§£
                extraInitialMonthly = solveDiagnostic('extraMonthly');
                safeMonthlySpend = solveDiagnostic('safeSpend');

                // Extra Years Logic
                extraYears = Math.round(solveDiagnostic('extraYears'));
                if (extraYears > 20) extraYears = "20+";
                if (extraYears === 0 && finalSuccessRate < targetRate) extraYears = 1;

                // ç”Ÿæˆå»ºè­° HTML
                let html = `
                    <div class="sol-header">
                        <div class="sol-icon">ğŸ’¡</div>
                        <div class="sol-title" style="color:#ff6b6b;">ç™¼ç¾é¢¨éšª</div>
                    </div>
                    <div class="sol-body">
                        ç›®å‰çš„è³‡ç”¢é…ç½®åœ¨æœ€å·®æƒ…æ³ä¸‹å¯èƒ½ç„¡æ³•æ”¯æ’åˆ°çµ‚è€ï¼Œå»ºè­°èª¿æ•´ä»¥ä¸‹åƒæ•¸ï¼š
                    </div>
                `;

                if (extraInitialMonthly > 0) {
                    html += `<div class="solution-item">
                        <div>â€¢ æ–¹æ¡ˆ A (èµ·é»åŠ ç¢¼)ï¼šç¾åœ¨æ¯æœˆéœ€å¢åŠ  <strong style="color:var(--warn)">${formatMoney(extraInitialMonthly).replace("NT$", "")}</strong>å…ƒã€‚</div>
                        <button class="apply-btn" onclick="applySchemeA(${extraInitialMonthly})">å¥—ç”¨</button>
                    </div>`;
                }
                if (extraYears > 0 || typeof extraYears === 'string') {
                    html += `<div class="solution-item">
                        <div>â€¢ æ–¹æ¡ˆ B (å»¶å¾Œé€€ä¼‘)ï¼šå»ºè­°å†å¤šå·¥ä½œ <strong style="color:var(--info)">${extraYears}</strong>å¹´ã€‚</div>
                        <button class="apply-btn" onclick="applySchemeB(${typeof extraYears === 'number' ? extraYears : 20})">å¥—ç”¨</button>
                    </div>`;
                }
                if (safeMonthlySpend < monthlySpend) {
                    html += `<div class="solution-item">
                        <div>â€¢ æ–¹æ¡ˆ C (ç¯€çœé–‹æ”¯)ï¼šå°‡é€€ä¼‘æœˆèŠ±è²»é™è‡³ <strong style="color:var(--accent)">${formatMoney(safeMonthlySpend).replace("NT$", "")}</strong>å…ƒã€‚</div>
                        <button class="apply-btn" onclick="applySchemeC(${safeMonthlySpend})">å¥—ç”¨</button>
                    </div>`;
                } else {
                    html += `<div class="solution-item" style="color:#aaa">â€¢ æ–¹æ¡ˆ Cï¼šå¸‚å ´æ³¢å‹•éå¤§ï¼Œå–®ç´”ç¯€æµæ•ˆæœæœ‰é™ã€‚</div>`;
                }
                document.getElementById('solutionContent').innerHTML = html;
            }

            drawChart(history, principalHistory, nominalPrincipalHistory, workYears, totalYears);
            drawFlowChart(flowHistory, workYears, totalYears);
        }

        function drawFlowChart(data, workYears, totalYears) {
            const canvas = document.getElementById('flowChart');
            const tooltip = document.getElementById('flowTooltip');
            const ctx = canvas.getContext('2d');

            // High DPI
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            if (rect.width === 0) return;

            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);

            const w = rect.width;
            const h = rect.height;
            const padding = { top: 20, right: 30, bottom: 30, left: 60 };
            const chartW = w - padding.left - padding.right;
            const chartH = h - padding.top - padding.bottom;

            ctx.clearRect(0, 0, w, h);

            // Find Max for Y Scale (Absolute value)
            let maxVal = 0;
            data.forEach(d => {
                if (Math.abs(d.val) > maxVal) maxVal = Math.abs(d.val);
            });
            maxVal = maxVal * 1.1; // Margin

            // é›¶é»ä½ç½® (Zero Line) - å› ç‚ºæœ‰æ­£è² å€¼
            // æˆ‘å€‘å¸Œæœ›æ­£è² æ¯”ä¾‹æ­£ç¢ºã€‚ Total Range = 2 * maxVal? 
            // é‚„æ˜¯ Input é€šå¸¸è¼ƒå°? 
            // ç°¡å–®èµ·è¦‹ï¼Œè¨­ä¸€å€‹ Zero Yã€‚

            // ç‚ºäº†è®“åœ–å¥½çœ‹ï¼Œæˆ‘å€‘æª¢æŸ¥ Input max å’Œ Output max
            let maxIn = 0;
            let maxOut = 0; // consistent positive
            data.forEach(d => {
                if (d.type === 'IN' && d.val > maxIn) maxIn = d.val;
                if (d.type === 'OUT' && Math.abs(d.val) > maxOut) maxOut = Math.abs(d.val);
            });

            // Yè»¸ç¯„åœï¼š +maxIn ~ -maxOut
            let topVal = maxIn * 1.1;
            let bottomVal = maxOut * 1.1;
            let totalRange = topVal + bottomVal;

            // Yåº§æ¨™è½‰æ›
            function getY(val) {
                // val is positive or negative
                // pure ratio from top
                // Top (val = topVal) -> padding.top
                // Bottom (val = -bottomVal) -> padding.top + chartH

                let ratio = (topVal - val) / totalRange;
                return padding.top + ratio * chartH;
            }

            function getX(year) {
                // year 1 to totalYears
                // bar width handling? Center align?
                return padding.left + (year / totalYears) * chartW;
            }

            // Draw Zero Line
            let yZero = getY(0);
            ctx.beginPath();
            ctx.strokeStyle = "#666";
            ctx.moveTo(padding.left, yZero);
            ctx.lineTo(w - padding.right, yZero);
            ctx.stroke();

            // Draw Bars
            let barWidth = (chartW / totalYears) * 0.8;

            data.forEach(d => {
                let x = getX(d.year) - (chartW / totalYears) / 2; // Shift to be centered? 
                // getX(t) returns right edge of t? No, linear.
                // Let's stick to standard: getX(t) = t * step.
                // Shift back slightly to center bar
                x = padding.left + ((d.year - 0.5) / totalYears) * chartW - barWidth / 2;

                let y = getY(d.val);
                let height = yZero - y; // if val > 0, y < yZero, height > 0

                ctx.fillStyle = d.type === 'IN' ? '#00bcd4' : '#ff9800'; // Blue vs Orange

                // Draw Rect
                // rect(x, y, w, h). If h is negative?
                // Using geometry:
                if (d.val >= 0) {
                    ctx.fillRect(x, y, barWidth, height);
                } else {
                    ctx.fillRect(x, yZero, barWidth, -height); // Draw downwards
                }
            });

            // Draw Axis Labels (Y)
            ctx.fillStyle = "#888";
            ctx.textAlign = "right";
            ctx.font = "10px Arial";
            // Top (+max)
            ctx.fillText(formatMoney(maxIn).replace("NT$", ""), padding.left - 5, getY(maxIn) + 4);
            // Bottom (-max)
            ctx.fillText("-" + formatMoney(maxOut).replace("NT$", ""), padding.left - 5, getY(-maxOut) + 4);

            // Hover Tooltip
            canvas.onmousemove = function (e) {
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;

                if (mouseX < padding.left || mouseX > w - padding.right) {
                    tooltip.style.display = "none";
                    return;
                }

                let ratio = (mouseX - padding.left) / chartW;
                let year = Math.ceil(ratio * totalYears);
                if (year < 1) year = 1;
                if (year > totalYears) year = totalYears;

                // Find data
                let item = data.find(d => d.year === year);
                if (!item) return;

                tooltip.style.display = "block";

                // Position logic (same as main chart)
                let relX = e.clientX - rect.left;
                let relY = e.clientY - rect.top;
                let toolLeft = relX + 15;
                if (toolLeft + 150 > w) toolLeft = relX - 160;

                tooltip.style.left = toolLeft + "px";
                tooltip.style.top = relY + "px"; // Near mouse

                let label = item.type === 'IN' ? "å¯¦è³ªæŠ•å…¥" : "å¯¦è³ªèŠ±è²»";
                let color = item.type === 'IN' ? "#00bcd4" : "#ff9800";
                let nomLabel = item.type === 'IN' ? "åç›®æŠ•å…¥" : "åç›®èŠ±è²»";

                tooltip.innerHTML = `
                    <div style="font-weight:bold; border-bottom:1px solid #555;">ç¬¬ ${year} å¹´</div>
                    <div style="color:${color}">${label}: ${formatMoney(Math.abs(item.val))}</div>
                    <div style="color:#aaa; font-size:0.9em; margin-top:3px;">(${nomLabel}: ${formatMoney(Math.abs(item.nominal))})</div>
                `;
            }
            canvas.onmouseleave = function () {
                tooltip.style.display = "none";
            }
        }

        function drawChart(history, principalHistory, nominalPrincipalHistory, workYears, totalYears) {
            const canvas = document.getElementById('chart');
            const tooltip = document.getElementById('tooltip');
            const ctx = canvas.getContext('2d');

            // Handle High DPI
            const dpr = window.devicePixelRatio || 1;
            // Fix: Use offsetWidth/Height to get CSS size, then set width/height attributes for DPI
            const rect = canvas.getBoundingClientRect();

            // Setup canvas size if not valid
            if (rect.width === 0) return;

            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            const w = rect.width;
            const h = rect.height;

            // Margins
            const padding = {
                top: 20, right: 30, bottom: 30, left: 60
            }

                ;
            const chartW = w - padding.left - padding.right;
            const chartH = h - padding.top - padding.bottom;

            ctx.imageSmoothingEnabled = true;
            ctx.clearRect(0, 0, w, h);

            // Prepare Data Lines
            let line10 = [],
                line50 = [],
                line90 = [];
            let maxVal = 0;

            for (let t = 0; t <= totalYears; t++) {
                history[t].sort((a, b) => a - b);
                let v10 = history[t][Math.floor(history[t].length * 0.1)];
                let v50 = history[t][Math.floor(history[t].length * 0.5)];
                let v90 = history[t][Math.floor(history[t].length * 0.9)];
                line10.push(v10);
                line50.push(v50);
                line90.push(v90);
                if (v90 > maxVal) maxVal = v90;
            }

            // Nice Scale for Y-axis
            maxVal = Math.ceil(maxVal * 1.1);
            if (maxVal === 0) maxVal = 100;

            function getX(year) {
                return padding.left + (year / totalYears) * chartW;
            }

            function getY(val) {
                return padding.top + chartH - (val / maxVal) * chartH;
            }

            // Draw Grid & Labels
            ctx.font = "11px Arial";
            ctx.fillStyle = "#888";
            ctx.strokeStyle = "#333";
            ctx.lineWidth = 1;

            // Y-axis grid
            const ySteps = 5;

            for (let i = 0; i <= ySteps; i++) {
                let val = (maxVal / ySteps) * i;
                let y = getY(val);

                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(w - padding.right, y);
                ctx.stroke();

                // Text
                ctx.textAlign = "right";
                let txt = Math.round(val / 10000) + "è¬";
                if (val >= 100000000) txt = (val / 100000000).toFixed(1) + "å„„";
                ctx.fillText(txt, padding.left - 8, y + 4);
            }

            // X-axis grid
            const xSteps = Math.min(totalYears, 10);
            const interval = Math.ceil(totalYears / xSteps);

            for (let t = 0; t <= totalYears; t += interval) {
                let x = getX(t);
                ctx.beginPath();
                ctx.moveTo(x, padding.top);
                ctx.lineTo(x, padding.top + chartH);
                ctx.stroke();

                ctx.textAlign = "center";
                ctx.fillText(t + "å¹´", x, padding.top + chartH + 15);
            }

            // Draw Retirement Line
            let retireX = getX(workYears);
            ctx.beginPath();
            ctx.setLineDash([5, 5]);
            ctx.strokeStyle = "#aaa";
            ctx.moveTo(retireX, padding.top);
            ctx.lineTo(retireX, padding.top + chartH);
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.textAlign = "left";
            ctx.fillText("é€€ä¼‘", retireX + 5, padding.top + 10);

            // Draw Lines
            function drawPath(data, color, width) {
                ctx.beginPath();
                ctx.strokeStyle = color;
                ctx.lineWidth = width;
                ctx.lineJoin = "round";

                for (let t = 0; t <= totalYears; t++) {
                    let x = getX(t);
                    let y = getY(data[t]);
                    if (t === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }

                ctx.stroke();
            }

            drawPath(line90, "#2ecc71", 2);
            drawPath(line50, "#f1c40f", 3);
            drawPath(line10, "#ff6b6b", 2);
            ctx.setLineDash([4, 4]); // è¨­å®šç‚ºè™›ç·š
            drawPath(principalHistory, "rgba(255, 255, 255, 0.2)", 2); // æŠ•å…¥æœ¬é‡‘ (ç°è‰²è™›ç·š)
            ctx.setLineDash([]); // æ¢å¾©å¯¦ç·š

            // --- Interaction ---
            canvas.onmousemove = function (e) {
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;

                if (mouseX < padding.left || mouseX > w - padding.right) {
                    tooltip.style.display = "none";
                    return;
                }

                let ratio = (mouseX - padding.left) / chartW;
                let year = Math.round(ratio * totalYears);
                if (year < 0) year = 0;
                if (year > totalYears) year = totalYears;

                tooltip.style.display = "block";

                // Tooltip Position (Relative to container)
                let relX = e.clientX - rect.left;
                let relY = e.clientY - rect.top;

                let toolLeft = relX + 15;
                let toolTop = relY + 15;

                // Prevent overflowing right edge of canvas
                if (toolLeft + 220 > w) toolLeft = relX - 225;

                tooltip.style.left = toolLeft + "px";
                tooltip.style.top = toolTop + "px";

                const v90 = formatMoney(line90[year]);
                const v50 = formatMoney(line50[year]);
                const v10 = formatMoney(line10[year]);
                const vp = formatMoney(principalHistory[year]);
                const vn = formatMoney(nominalPrincipalHistory[year]);

                let title = `ç¬¬ ${year} å¹´`;
                if (year === workYears) title += " (é€€ä¼‘é»)";

                tooltip.innerHTML = `
                    <div style="font-weight:bold; margin-bottom:5px; border-bottom:1px solid #555; padding-bottom:5px;">${title}</div>
                    <div class="tooltip-row"><span style="color:#2ecc71"><span class="dot" style="background:#2ecc71"></span>æ¨‚è§€ (PR90)</span><span>${v90}</span></div>
                    <div class="tooltip-row"><span style="color:#f1c40f"><span class="dot" style="background:#f1c40f"></span>ä¸­ä½ (PR50)</span><span>${v50}</span></div>
                    <div class="tooltip-row"><span style="color:#ff6b6b"><span class="dot" style="background:#ff6b6b"></span>æ‚²è§€ (PR10)</span><span>${v10}</span></div>
                    <div class="tooltip-row" style="margin-top:4px; border-top:1px dashed #555; padding-top:4px;"><span style="color:#888"><span class="dot" style="background:#888"></span>æŠ•å…¥æœ¬é‡‘ (å¯¦è³ª)</span><span>${vp}</span></div>
                    <div class="tooltip-row" style="color:#aaa; font-size:0.9em; justify-content: flex-end;">(åç›®ç´¯ç©: ${vn})</div>
                `;
            }

                ;

            canvas.onmouseleave = function () {
                tooltip.style.display = "none";
            }

                ;
        }

    </script>
</body>

</html>